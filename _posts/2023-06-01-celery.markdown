---
title: "Celery" #Article title.
date: 2023-06-01
category: [PYTHON, PYCORN] #One, more categories or no at all.
tag: [pycorn]
---

ğŸ’¡ __pycon korea 19 ì´ì§€í›ˆ__


## Celery?

ë©”ì„¸ì§€ ì „ë‹¬ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ë¹„ë™ê¸° task Queue

- client : ì‘ì—… ìš”ì²­
- Worker : ì‘ì—… ìˆ˜í–‰
- Broker : ë©”ì„¸ì§€ ì „ë‹¬

- AMQP(Advanced Message Queueing Protocol)
    - Celeryì˜ í•µì‹¬ í”„ë¡œí† ì½œ
        
        <img width="736" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-05-31 á„‹á…©á„’á…® 11 05 23" src="https://github.com/Hyun-Jun-Lee/hyun-jun-lee.github.io/assets/76996686/409c308d-8bc5-4d90-b80b-d4c9f6a5b91a">

        
    - ProducerëŠ” ë©”ì„¸ì§€ë¥¼ ìƒì„±í•˜ì—¬ Brokerì—ê²Œ ë³´ëƒ„
    - Broker ëŠ” Confirm(í™•ì¸)ì„í•˜ê³  consumerì—ê²Œ ì „ë‹¬
    - ConsumerëŠ” Broker Acknowledgeë¥¼ ë°›ì•„ì„œ ì•ˆì •ì ìœ¼ë¡œ ë©”ì„¸ì§€ ì „ë‹¬í•˜ê²Œ í•¨

## ì•ˆì •ì ìœ¼ë¡œ ì™„ë£Œí•˜ê¸°

### Late ACK

Celery Workerê°€ ack í•˜ëŠ” ì‹œì 

- Default
    - Workerê°€ task ì‹¤í–‰í•˜ê¸° ì§ì „ì— ack
    - ì‹¤í–‰ë˜ì§€ ëª»í•˜ë”ë¼ë„ BrokerëŠ” ackë¥¼ ë°›ì•˜ê¸° ë•Œë¬¸ì— íì—ì„œ í•´ë‹¹ taskë¥¼ ì œê±°ì‹œí‚´
- `acks_late=True`
    - task ì‹¤í–‰ì´ ë‹¤ ì™„ë£Œë˜ëŠ” ì‹œì ì—ì„œ ack
    - taskê°€ ì‹¤í–‰ë˜ì§€ ëª»í•´ë„ ì•„ì§ íì— ë‚¨ì•„ìˆì–´ì„œ ë‹¤ì‹œ ì‹¤í–‰ê°€ëŠ¥í•œ ì•ˆì •ì„± í™•ë³´
    - ê·¸ëŸ¬ë‚˜ ì¤‘ë³µ ì‹¤í–‰ ë  ìˆ˜ë„ ìˆìŒ!
    
    ```python
    @app.task(acks_late=True)
    def my_task(x):
        result = x * 2
        return result
    ```
    

### Task Retry

- task retry ì˜µì…˜
    - Atomicity
    - ì˜ˆìƒê°€ëŠ¥í•œ Exceptionì—ë§Œ ì ìš©
    
    ```python
    @app.task(autoretry_for=(ConnectionError,), # ìë™ ì¬ì‹œë„ë¥¼ ìˆ˜í–‰í•  ì˜ˆì™¸ í´ë˜ìŠ¤
    					retry_backoff=2, # ì¬ì‹œë„ ì‹œê°„ ê°„ê²©(secodns)
    					retry_kwargs={'max_retries':3}) # ìµœëŒ€ ì¬ì‹œë„ ìˆ˜ ì§€ì •
    def send_mail(..):
    	...
    ```
    

### Visibility Timeout

ë©”ì‹œì§€ê°€ ì‘ì—…ìì—ê²Œ ì „ë‹¬ëœ í›„ì— ì–¼ë§ˆ ë™ì•ˆ ë‹¤ë¥¸ ì‘ì—…ìê°€ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ìƒíƒœë¡œ ìœ ì§€í•˜ëŠ” ì‹œê°„ ì„¤ì •, ì¦‰ í•´ë‹¹ ì‹œê°„ì´ ì§€ë‚˜ë©´ ë‹¤ë¥¸ workerì—ê²Œ taskê°€ ë°°ì •ëœë‹¤.

```python
@app.task(bind=True, visibility_timeout=10)
def my_task_with_visibility_timeout(self, x):
    result = x * 2
    return result
```

ì‘ì—…ìê°€ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ë°›ì€ í›„ 10ì´ˆ ë™ì•ˆ ë‹¤ë¥¸ ì‘ì—…ìê°€ ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤. 

ë§Œì•½ 10ì´ˆ ë‚´ì— ì‘ì—…ìê°€ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šìœ¼ë©´ ë©”ì‹œì§€ëŠ” ë‹¤ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒíƒœë¡œ ê°„ì£¼ë¨

ê·¸ë˜ì„œ ì¥ì‹œê°„ ì‹¤í–‰ë˜ëŠ” taskë¼ë©´ `visibility_timeout` ì˜µì…˜ì„ ê¸¸ê²Œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ë¨

## íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸°

- ì‘ì—…ì˜ ì²˜ë¦¬ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì²˜ë¦¬
    - IO / CPU
    - ì¤‘ìš”ë„
    - ìˆ˜í–‰ì‹œê°„
    - ì‹¤í–‰ ë¹ˆë„

### Limits

- Time Limit
    - taskê°€ ì¼ì • ì‹œê°„ ì´ìƒ ì‹¤í–‰ë˜ê³  ìˆìœ¼ë©´ ì¢…ë£Œ
    - `soft_time_limit=60` , 60ì´ˆê°€ ì§€ë‚˜ë©´ **`SoftTimeLimitExceeded` raise**
    - `hard_time_limit=60`
    - ê¸€ë¡œë²Œ ì„¤ì •ë„ ê°€ëŠ¥(`app.conf.worker_soft_time_limit = 60`)

### Prefetch

- worker_prefetch_multiplier

### Gevent/ Eventlet

- Gevent
    
    ```python
    from celery import Celery
    from gevent import monkey
    
    # geventê°€ I/O ì‘ì—…ì„ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ íŒŒì´ì¬ ë‚´ì¥ ëª¨ë“ˆë“¤ì„ ëŒ€ì²´í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ëŠ” ì—­í• 
    monkey.patch_all()
    
    app = Celery('tasks', broker='redis://localhost:6379', backend='redis://localhost:6379')
    
    @app.task
    def my_task(x):
        # I/O ì‘ì—… ìˆ˜í–‰
        perform_io_operation(x)
        return x
    ```
    
- Eventlet
    
    ```python
    from celery import Celery
    import eventlet
    
    eventlet.monkey_patch()
    
    app = Celery('tasks', broker='redis://localhost:6379', backend='redis://localhost:6379')
    
    @app.task
    def my_task(x):
        # I/O ì‘ì—… ìˆ˜í–‰
        perform_io_operation(x)
        return x
    ```
    

### Prefork

## Use Multi Queue

- Queue ì„¤ì •

```python
from celery import Celery
from kombu import Queue

# Celery app ê°ì²´ ìƒì„±í•˜ê³  appì´ë¦„ì„ test
app = Celery('test')
# í™˜ê²½ ë³€ìˆ˜ DJANGO_SETTINGS_MODULEì„ "config.settings"ë¡œ ì„¤ì •
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
# Djangoì˜ ì„¤ì • íŒŒì¼ì—ì„œ CELERY ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ì„¤ì • ê°’ì„ ë¡œë“œí•˜ëŠ” ì—­í• 
app.config_from_object('django.conf:settings', namespace='CELERY')
# taskì— íë¥¼ ì§€ì •í•˜ì§€ ì•Šì•˜ì„ ë•Œ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©ë  í ì§€ì •
app.conf.task_default_queue = 'default'
app.conf.task_queues = (
	Queue('slow_tasks', routing_key='slow.#'),
	Queue('quick_tasks', routing_key='quick.#'),
)
```

- task

```python
@app.task
def slow_task(x):
	time.sleep(x)
	return x

@app.task
def quick_task(x):
	return x

for i in range(10, 100):
	slow_task.apply_async(args=[i], queue='slow_tasks')

quick_task.apply_async(args=[100], queue='quick_tasks')
```

- worker ì‹¤í–‰
    - `celery -A tasks worker -Q slow_tasks --loglevel=info`
    - `celery -A tasks worker -Q quick_tasks --loglevel=info`