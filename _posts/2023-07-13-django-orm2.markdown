---
title: "SQLì„ ì´í•´í•˜ê³  ì‚¬ìš©í•˜ëŠ” Django ORM" #Article title.
date: 2023-07-13
category: [PYTHON, DJANGO] #One, more categories or no at all.
tag: [pycorn, django, python]
---

__PyCon korea 2022 ì‹ ë™í˜„__

# SQLì„ ì´í•´í•˜ê³  ì‚¬ìš©í•˜ëŠ” Django ORM

## 1. ê¸°ë³¸ SQL

<aside>
ğŸ’¡ QuerySetì€ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¥¼ í†µí•´ ì–»ì€ ë°ì´í„°ì´ë‹¤

</aside>

### í˜¸ì¶œí•œ SQL ë° ì„±ëŠ¥ì„ ìœ„í•œ  ì‹¤í–‰ ê³„íš í™•ì¸

- QuerySetì— ì˜í•´ í˜¸ì¶œëœ sql í™•ì¸ í•˜ëŠ”ë²•
    
    ```python
    import sqlparse
    
    query = str(queryset.query)
    print(sqlparse.format(query, reindent=True)
    ```
    
- SQL ì‹¤í–‰ ê³„íš í™•ì¸

```python
>> print(queryset.explain())

1 SIMPLE User None ALL None None None None 1
100.09 using filesort
100.09 using filesort
```

### Count(), Aggregate()

- count() vs aggregate()
    - aggregate()
    
    ```python
    >> User.objects.aggregate(Count('id'))
    # __countëŠ” django default naming
    # aliasë¥¼ ì¶”ê°€í•˜ë ¤ë©´ .aggregate(count=Count('id'))ì™€ ê°™ì´ ì‚¬ìš©
    {"id__count" : 3}
    
    SELECT COUNT(id) as id__count
    FROM User
    ```
    
    - count()
    
    ```python
    >> User.objects.all().count()
    3
    
    SELECT COUNT(*)
    FROM User
    ```
    
    - `aggregate()` ì™€ ê°™ì´ íŠ¹ì • ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„í•  ë•ŒëŠ” ê°’ì´ `NULL` ì¸ ë ˆì½”ë“œëŠ” ì§‘ê³„ì—ì„œ ì œì™¸ë˜ê¸° ë•Œë¬¸ì—, `count(id)` ì™€ `count(*)` ê°€ ë‹¤ë¥¸ ê°’ì„ ë¦¬í„´ í•  ìˆ˜ë„ ìˆë‹¤

### UNION

`union()` ìœ¼ë¡œ ì¿¼ë¦¬ì…‹ì„ í•©ì¹  ìˆ˜ ìˆê³ , í•©ì¹˜ë ¤ëŠ” í…Œì´ë¸”ì˜ ì»¬ëŸ¼ ê°¯ìˆ˜ê°€ ê°™ì•„ì•¼ ê°€ëŠ¥í•˜ë‹¤

`union()` ì€ ê¸°ë³¸ì ìœ¼ë¡œ unique ì˜µì…˜ì´ ì ìš©ë˜ê¸° ë•Œë¬¸ì—, unique ê²€ì‚¬ê°€ í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´ `all=True` ì‚¬ìš©

```sql
books = Book.objects.all()
ebooks = Ebook.objects.all()

(SELECT *
FROM Book) UNION (
SELECT *
FROM Ebook)
```

### ANNOTATE

UNIONì´ ìˆ˜ì§ìœ¼ë¡œ í…Œì´ë¸”ì„ í™•ì¥ì‹œí‚¨ë‹¤ë©´, ANNOTATEëŠ” ìˆ˜í‰ìœ¼ë¡œ í™•ì¥ì‹œí‚´

```python
from django.db.models import Value

books = Book.objects.annotate(book_type=Value('book'))
ebooks = Ebook.objects.annotate(book_type=Value('e-book'))
```

### F()

ì»¬ëŸ¼ ê°„ì˜ ì—°ì‚° ê°€ëŠ¥

```python
from django.db.models import F

Book.objects.annotate(
	sale_price=F('price')-F('discount')
	)
```

```sql
SELECT 
	id,
	title,
	price,
	discount,
	price - discount AS sale_price
FROM Book
```

### Only()

SELECT ë¬¸ì— íŠ¹ì • ì»¬ëŸ¼ë§Œ ì¶œë ¥í•˜ê³  ì‹¶ì€ ê²½ìš° `only()` ë¥¼ ì‚¬ìš©í•˜ë©´, ì¸ë±ìŠ¤ë¥¼ í™œìš©í•  ìˆ˜ ìˆëŠ” ê²½ìš° ë” ë¹ ë¥´ê²Œ ì‘ë‹µë¨

### GROUP BY

`values()` ,`annotate()` ë¥¼ í•¨ê¼ ì‚¬ìš©í•˜ë©´ GROUP BYë¡œ ì‘ë™í•¨

```sql
# values()ì—ëŠ” ì§‘í•©ì„ êµ¬ë¶„í•  ì»¬ëŸ¼ ì§€ì •
User.objects.values('type').annotate(count=Count('id'))

SELECT 
	type,
	COUNT(id) AS count
FROM
	User
GROUP BY
	type
```

## ì‘ìš©

### 1. Index í™œìš©

- ì¼ë°˜ì ìœ¼ë¡œ Cardinalityê°€ ë†’ì€, ì¦‰ ìœ ë‹ˆí¬í•œ ê°’ì˜ ê°¯ìˆ˜ê°€ ë§ì€ ì»¬ëŸ¼ì„ indexë¡œ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤
    - ex) ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ê°€ ì„±ë³„ ë³´ë‹¤ Cardinalityê°€ ë†’ìŒ
- `filter()` , `order_by()`, `values()` ì™€ ê°™ì€ ì¡°íšŒ ë° ì •ë ¬ì´ ìì£¼ ì‚¬ìš© ë˜ëŠ” ì»¬ëŸ¼ì€ index ì¶”ê°€ë¥¼ ê³ ë ¤í•´ë³¼ë§Œí•¨

### 2. Index ì¶”ê°€

- Meta classì— ì¶”ê°€
    - ê° í•„ë“œì— ì˜µì…˜ìœ¼ë¡œ ì§€ì •í•´ì¤„ ìˆ˜ ìˆì§€ë§Œ, ì•„ë˜ì™€ ê°™ì´ Meta classë¡œ í•œë²ˆì— ê´€ë¦¬í•˜ëŠ” ê²ƒì„ ì¶”ì²œ
    
    ```python
    class Foo(models.Model):
    	...
    	class Meta:
    			indexes = [
    					models.index(fields=['single_column']),
    					models.index(fields=['multi','column'])
    					]
    ```
    
- Django Modelì— ìœ ë‹ˆí¬ ì œì•½ì„ ê±¸ ê²½ìš° ìë™ìœ¼ë¡œ indexê°€ ìƒì„±ë¨
    
    ```python
    class Foo(models.Model):
    	...
    	class Meta:
    			constraints = [
    					models.UniqueConstraint(fields=['single_column']),
    					models.UniqueConstraint(fields=['multi','column'])
    					]
    ```
    

### 3. ì¤‘ë³µ Index ì‚­ì œ

ë°ì´í„° ì¡°íšŒ ì‹œ indexëŠ” í•˜ë‚˜ë§Œ ì‚¬ìš©ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ForeignKeyì— ì˜í•´ ê¸°ë³¸ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ì¸ë±ìŠ¤ëŠ” ë¶ˆí•„ìš”í•˜ê¸° ë•Œë¬¸ì—, ë¯¸ë¦¬ ìƒì„±ë˜ì§€ ì•Šê²Œ ê´€ë¦¬

```python
class Order(models.Model):
	product = models.ForeignKey(
			'Procut',
			on_delete=models.SET_NULL,
			db_index=False
			)
	class Meta:
			indexes = [
					models.index(fields=['product','ordered_at'])
					]

```

### 4. Indexë¥¼ í™œìš©í•˜ëŠ” ì¿¼ë¦¬

indexë¥¼ ì¶”ê°€í•˜ê¸°ë§Œ í•´ì„œ ë¬´ì¡°ê±´ ì„±ëŠ¥ì´ í–¥ìƒí•˜ëŠ” ê²ƒì€ ì•„ë‹ˆê¸°ì—, indexë¥¼ ì˜ ì„¤ê³„í•˜ëŠ” ê²ƒë§Œí¼ì´ë‚˜ ì˜ ë™ì‘í•˜ë„ë¡ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ëŠ” ê²ƒì´ ì¤‘ìš”

- ì¡°íšŒí•˜ëŠ” ì»¬ëŸ¼ì„ ìˆ˜ì •í•˜ëŠ” ì¿¼ë¦¬ëŠ” ì¸ë±ìŠ¤ë¥¼ ë¬´ì‹œí•¨
    - `__contains(LIKE â€˜%..%â€™)` ,`__year(YEAR(date)`
- `contains`
    - `contains` ëŠ” LIKEë¬¸ìœ¼ë¡œ ë³€í™˜ë˜ëŠ”ë°, ì•„ë˜ì™€ ê°™ì€ ìƒí™©ì€ â€˜Guidoâ€™ê°€ í¬í•¨ëœ ëª¨ë“  ë¬¸ìë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°ë¥¼ ì¡°íšŒ í•˜ê¸°ë•Œë¬¸ì—,  nameìœ¼ë¡œ ì¸ë±ìŠ¤ê°€ ì„¤ì •ë˜ì–´ ìˆì–´ë„ ë¬´ì‹œëœë‹¤
        
        ```python
        User.objects.filter(name__contains='Guido')
        
        SELECT *
        FROM User
        WHERE name LIKE '%Guido%'
        ```
        
    - ê·¸ë˜ì„œ indexë¥¼ í™œìš©í•  ìˆ˜ ìˆëŠ” `startswith` ì‚¬ìš©ì„ ê¶Œì¥
        
        ```python
        User.objects.filter(name__startswith='Guido')
        
        SELECT *
        FROM User
        WHERE name LIKE 'Guido%'
        ```
        
- ì»¤ë²„ë§ ì¸ë±ìŠ¤